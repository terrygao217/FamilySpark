<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº²å¿ƒå­¦å›­ - FamilySpark</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* -------------------- åŸºç¡€ä¸å˜é‡ -------------------- */
        :root {
            --primary-color: #4CAF50; /* æ¸…æ–°ç»¿è‰² */
            --secondary-color: #FFC107; /* æ´»æ³¼é»„è‰² */
            --text-color: #333;
            --light-gray: #f4f7f6;
            --card-bg: #fff;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--text-color);
            padding: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* -------------------- é¡µé¢å®¹å™¨ -------------------- */
        .page {
            max-width: 900px;
            margin: 20px auto;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        /* -------------------- é€šç”¨ç»„ä»¶ -------------------- */
        input[type="text"], input[type="number"], input[type="password"], textarea, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            transition: all 0.2s;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .danger {
            background-color: var(--danger-color);
        }
        .danger:hover {
            background-color: #d32f2f;
        }
        .warning {
            background-color: var(--warning-color);
        }
        .warning:hover {
            background-color: #f57c00;
        }

        .card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary-color);
        }

        /* -------------------- å¯åŠ¨é¡µæ ·å¼ -------------------- */
        #auth-page h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
        }

        .identity-selection {
            text-align: center;
            margin-bottom: 20px;
        }
        .identity-selection label {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 8px;
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .identity-selection input[type="radio"] {
            display: none;
        }

        .identity-selection input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: white;
        }

        .remember-me {
            display: block;
            margin-top: -5px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        
        /* å¯†é’¥å±•ç¤ºåŒº */
        #secret-key-display {
            background-color: #e8f5e9; /* æµ…ç»¿è‰²èƒŒæ™¯ */
            border: 2px dashed var(--primary-color);
            color: #388e3c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            word-break: break-all;
        }
        #secret-key-display span {
            font-size: 1.2em;
            color: var(--danger-color);
        }

        /* -------------------- ä»»åŠ¡æ¨¡å—æ ·å¼ -------------------- */
        .task-item button {
             /* ç¡®ä¿æ‰“å¡æŒ‰é’®æ˜¯ç»¿è‰²çš„ */
            background-color: var(--primary-color);
        }
        .task-item button.pending {
            background-color: var(--warning-color);
            cursor: not-allowed;
        }
        .task-item button.approved {
            background-color: #777; /* å®¡æ ¸é€šè¿‡åç°è‰² */
            cursor: not-allowed;
        }
        
        /* å¾…å®¡æ ¸åˆ—è¡¨ */
        .pending-review-item {
            border-left-color: var(--warning-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .review-image-container {
            margin: 10px 0;
            text-align: center;
        }
        .review-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        /* -------------------- ç•™è¨€æ¨¡å—æ ·å¼ (ä¿æŒä¸å˜) -------------------- */
        .message-item {
            background-color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary-color);
            position: relative;
        }
        .message-item.private {
            border-left: 4px solid #9c27b0; /* ç´«è‰²è¡¨ç¤ºç§å¯† */
            background-color: #f3e5f5;
        }

        /* -------------------- å¼¹çª— (Modal) -------------------- */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
            position: relative;
            animation: fadeIn 0.3s;
        }

        /* æ‰“å¡æ‹ç…§åŒºåŸŸ */
        #video-stream, #captured-image {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            display: block;
        }
        #video-stream {
             height: 200px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .camera-controls button {
             width: 50%;
        }
        
        #check-in-photo-preview {
             text-align: center;
             margin-bottom: 15px;
        }
        #check-in-photo-preview img {
             max-width: 100%;
             max-height: 200px;
             border-radius: 8px;
        }

    </style>

</head>
<body>

    <div id="auth-page" class="page">
        <h2>ğŸ‰ æ¬¢è¿æ¥åˆ°äº²å¿ƒå­¦å›­ï¼</h2>
        <p>è¯·é€‰æ‹©æ‚¨çš„èº«ä»½å¹¶è®¾ç½®ä¸“å±æ˜µç§°</p>
        <div class="identity-selection">
            <label><input type="radio" name="identity" value="student" checked> <i class="fas fa-child"></i> å­¦ç”Ÿ</label>
            <label><input type="radio" name="identity" value="parent"> <i class="fas fa-user-tie"></i> å®¶é•¿</label>
        </div>
        <input type="text" id="nickname-input" placeholder="è¾“å…¥æ‚¨çš„ä¸“å±æ˜µç§° (å¦‚: æ•°å­¦å°èƒ½æ‰‹)">
        
        <div id="local-password-area">
            <input type="password" id="local-password" placeholder="è®¾ç½®/è¾“å…¥æœ¬åœ°è®¿é—®å¯†ç  (ç”¨äºä¿æŠ¤æ•°æ®)">
        </div>

        <div id="secret-key-area">
            <input type="text" id="secret-key-input" placeholder="è¾“å…¥å¯¹æ–¹çš„é…å¯¹å¯†é’¥ (é¦–æ¬¡ä½¿ç”¨ç•™ç©º)">
        </div>

        <label class="remember-me">
            <input type="checkbox" id="remember-me" checked> è®°ä½èº«ä»½ä¸æ˜µç§°
        </label>
        <button id="start-app-btn">ğŸš€ è¿›å…¥ç©ºé—´</button>
        
        <div id="secret-key-display" class="hidden">
            <p>æ‚¨çš„ã€é…å¯¹å¯†é’¥ã€‘æ˜¯ï¼š<span id="my-secret-key"></span></p>
            <p style="font-size: 0.8em; margin-top: 5px;">è¯·åŠ¡å¿…å°†æ­¤å¯†é’¥**å®‰å…¨**åˆ†äº«ç»™å¦ä¸€ä½å®¶åº­æˆå‘˜è¿›è¡Œé…å¯¹ï¼</p>
        </div>
    </div>

    <div id="main-app" class="page hidden">
        <header>
            <span id="current-user-display"></span>
            <nav>
                <button id="nav-tasks" class="active"><i class="fas fa-check-circle"></i> æ‰“å¡å¥–åŠ±</button>
                <button id="nav-messages"><i class="fas fa-comments"></i> åŒå‘ç•™è¨€</button>
                <button id="nav-leaderboard"><i class="fas fa-trophy"></i> æ’è¡Œæ¦œ</button>
                <button id="nav-settings" class="settings-btn"><i class="fas fa-cog"></i> è®¾ç½®</button>
            </nav>
        </header>

        <div id="settings-menu" class="hidden">
            <button id="change-nickname-btn">ä¿®æ”¹æ˜µç§°</button>
            <button id="switch-identity-btn">åˆ‡æ¢èº«ä»½</button>
            <button id="show-my-key-btn" class="warning">æ˜¾ç¤ºæˆ‘çš„é…å¯¹å¯†é’¥</button>
            <button id="clear-data-btn" class="danger">æ¸…é™¤æœ¬åœ°è®°å¿†</button>
        </div>

        <div id="content-container">
            </div>

        <div id="tips-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn tips-close-btn">&times;</span>
                <h3>ğŸ’¡ å­¦ä¹ å°Tips!</h3>
                <p id="tip-content"></p>
            </div>
        </div>
        
        <div id="task-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn task-close-btn">&times;</span>
                <h4>ğŸ“ åˆ›å»º/ç¼–è¾‘å­¦ä¹ ä»»åŠ¡</h4>
                <input type="hidden" id="task-id">
                <input type="text" id="task-name" placeholder="ä»»åŠ¡åç§° (å¦‚: æ•´ç†ä¹¦æ¡Œ / æ•°å­¦å‹è½´é¢˜)">
                <select id="task-category">
                    <option value="study">å­¦ç§‘å­¦ä¹ </option>
                    <option value="chore">å®¶åŠ¡åŠ³åŠ¨</option>
                </select>
                <input type="number" id="task-points" min="1" value="10" placeholder="ä»»åŠ¡ç§¯åˆ†">
                
                <label style="display: block; margin: 15px 0 5px;">
                    <input type="checkbox" id="task-requires-photo" style="width: auto; margin-right: 10px;">
                    éœ€è¦æ‹ç…§è¯æ˜ (æ‰“å¡æ—¶éœ€ä¸Šä¼ å›¾ç‰‡)
                </label>
                
                <button id="save-task-btn">ä¿å­˜ä»»åŠ¡</button>
            </div>
        </div>
        
        <div id="reward-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn reward-close-btn">&times;</span>
                <h4>ğŸ è®¾ç½®å…‘æ¢å¥–åŠ±</h4>
                <input type="hidden" id="reward-id">
                <input type="text" id="reward-name" placeholder="å¥–åŠ±åç§° (å¦‚: è¯¾å¤–ä¹¦ / å‘¨æœ«å‡ºæ¸¸)">
                <input type="number" id="reward-cost" min="1" value="30" placeholder="æ‰€éœ€ç§¯åˆ†">
                <button id="save-reward-btn">ä¿å­˜å¥–åŠ±</button>
            </div>
        </div>

        <div id="check-in-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-btn check-in-close-btn">&times;</span>
                <h4 id="check-in-task-name"></h4>
                <input type="hidden" id="check-in-task-id">

                <div id="check-in-photo-section">
                    <p>ğŸ“¸ **ä¸Šä¼ æ‰“å¡è¯æ˜ (ç…§ç‰‡)**</p>
                    <video id="video-stream" autoplay playsinline class="hidden"></video>
                    <canvas id="captured-image" class="hidden"></canvas>
                    <div id="check-in-photo-preview"></div>
                    
                    <div class="camera-controls">
                        <button id="start-camera-btn" class="warning"><i class="fas fa-camera"></i> å¯åŠ¨ç›¸æœº</button>
                        <button id="take-photo-btn" class="hidden"><i class="fas fa-camera-retro"></i> æ‹ç…§</button>
                    </div>
                    <p style="text-align:center; margin-bottom: 10px;">æˆ–è€…</p>
                    <input type="file" id="photo-upload-input" accept="image/*">
                </div>
                
                <button id="submit-check-in-btn">âœ… æäº¤æ‰“å¡ç­‰å¾…å®¡æ ¸</button>
                <button id="skip-photo-btn" class="warning hidden">ä»…æ–‡å­—æ‰“å¡ (æ— éœ€ç…§ç‰‡)</button>
            </div>
        </div>

    </div>

    <script>
        // å…¨å±€å¸¸é‡å’ŒçŠ¶æ€
        let currentUser = {
            identity: null, // 'student' æˆ– 'parent'
            nickname: null,
            remember: false,
            password: null, // Base64ç¼–ç çš„æœ¬åœ°å¯†ç 
            secretKey: null, // è‡ªå·±çš„é…å¯¹å¯†é’¥
            partnerKey: null // å¯¹æ–¹çš„é…å¯¹å¯†é’¥
        };

        const LS_PREFIX = 'pcl_';

        // æ¨¡å—æ•°æ®ç»“æ„ï¼ˆä½¿ç”¨å¯¹è±¡ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼‰
        let appData = {
            tasks: [],        // ä»»åŠ¡åˆ—è¡¨
            rewards: [],      // å¥–åŠ±åˆ—è¡¨
            points: 0,        // å½“å‰ç§¯åˆ†
            taskRecords: [],  // æ‰“å¡è®°å½•: [{ date, nickname, taskName, points, requiresPhoto, photoData, status: 'pending/approved/rejected' }, ...]
            messages: [],     // ç•™è¨€åˆ—è¡¨
        };

        // å­¦ä¹ Tipsæ•°æ®
        const TIPS = [
            "ã€æ•°å­¦ã€‘é‡åˆ°å‡½æ•°å‹è½´é¢˜ï¼Œå…ˆå°è¯•æ±‚å¯¼æ‰¾æå€¼ç‚¹ï¼Œå…³æ³¨å®šä¹‰åŸŸçš„è¾¹ç•Œæƒ…å†µã€‚",
            "ã€è‹±è¯­ã€‘æ¯å¤©èƒŒè¯µ10ä¸ªä¸ç†Ÿæ‚‰çš„é«˜é¢‘è¯æ±‡ï¼Œç»“åˆä¾‹å¥è®°å¿†æ•ˆæœæ›´ä½³ã€‚",
            "ã€å®¶åŠ¡ã€‘æ•´ç†æˆ¿é—´æ—¶ï¼Œéµå¾ª 'ä¸¢å¼ƒ-åˆ†ç±»-å½’ä½' ä¸‰æ­¥æ³•ï¼Œæ•ˆç‡ç¿»å€ï¼",
            "ã€å­¦ä¹ ã€‘å­¦ä¹ æ–°çŸ¥è¯†åï¼Œå°è¯•å‘åˆ«äººè®²è§£ï¼Œè¿™æ˜¯æœ€å¥½çš„æ£€éªŒæ–¹æ³•ã€‚",
            "ã€å¥åº·ã€‘æ¯å­¦ä¹ 45åˆ†é’Ÿï¼Œç«™èµ·æ¥æ´»åŠ¨5åˆ†é’Ÿï¼Œä¿æŠ¤è§†åŠ›å’Œé¢ˆæ¤ã€‚",
            "ã€å¿ƒæ€ã€‘é‡åˆ°éš¾é¢˜ä¸è¦æ…Œï¼Œè¯•ç€æŠŠå®ƒåˆ†è§£æˆå‡ ä¸ªå°æ­¥éª¤è§£å†³ã€‚"
        ];
        
        // æ‰“å¡çŠ¶æ€
        const TASK_STATUS = {
            PENDING: 'pending',
            APPROVED: 'approved',
            REJECTED: 'rejected',
            COMPLETED: 'completed' // ç«‹å³å®Œæˆï¼Œæ— éœ€å®¡æ ¸
        };
        
        let currentStream = null; // ç”¨äºå­˜å‚¨å½“å‰æ‘„åƒå¤´çš„åª’ä½“æµ
        let capturedPhotoData = null; // å­˜å‚¨ Base64 æ ¼å¼çš„å›¾ç‰‡
        let currentCheckInTask = null; // å­˜å‚¨å½“å‰æ‰“å¡çš„ä»»åŠ¡å¯¹è±¡

        // ----------------------- å¯†é’¥ç”Ÿæˆå‡½æ•° -----------------------
        function generateSecretKey() {
            // ä½¿ç”¨æ›´å¼ºçš„éšæœºæ€§ï¼Œç¡®ä¿é…å¯¹å¯†é’¥çš„å”¯ä¸€æ€§
            const array = new Uint8Array(8);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('').toUpperCase().substring(0, 8);
        }

        // ----------------------- ç®€å•åŠ å¯†/è§£å¯†å‡½æ•° (ä½¿ç”¨Base64æ¨¡æ‹Ÿ) -----------------------
        function encryptMessage(message, key) {
            // ç®€å•åŠ å¯†ï¼šå°†æ¶ˆæ¯å’Œå¯†é’¥æ··åˆå Base64 ç¼–ç 
            return btoa(message + '|||' + key);
        }

        function decryptMessage(encryptedMessage, key) {
            try {
                const decoded = atob(encryptedMessage);
                // æ£€æŸ¥è§£ç åçš„å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«æ­£ç¡®çš„å¯†é’¥
                if (decoded.endsWith('|||' + key)) {
                    return decoded.substring(0, decoded.length - (key.length + 3));
                }
                return null; // è§£å¯†å¤±è´¥æˆ–å¯†é’¥ä¸åŒ¹é…
            } catch (e) {
                return null;
            }
        }


        // --- I. æ ¸å¿ƒåˆå§‹åŒ–ä¸èº«ä»½/æ˜µç§°æ¨¡å— ---

        document.addEventListener('DOMContentLoaded', () => {
            // ç»‘å®šå¯¼èˆªäº‹ä»¶
            document.getElementById('nav-tasks').addEventListener('click', () => loadModule('tasks'));
            document.getElementById('nav-messages').addEventListener('click', () => loadModule('messages'));
            document.getElementById('nav-leaderboard').addEventListener('click', () => loadModule('leaderboard'));

            // ç»‘å®šè®¾ç½®èœå•äº‹ä»¶
            document.getElementById('nav-settings').addEventListener('click', toggleSettingsMenu);
            document.getElementById('change-nickname-btn').addEventListener('click', promptChangeNickname);
            document.getElementById('switch-identity-btn').addEventListener('click', switchToAuthPage);
            document.getElementById('clear-data-btn').addEventListener('click', clearLocalData);
            document.getElementById('show-my-key-btn').addEventListener('click', showMySecretKey);
            
            // ç»‘å®šå¯åŠ¨é¡µäº‹ä»¶
            document.getElementById('start-app-btn').addEventListener('click', handleStartApp);
            
            // å…³é—­Modaläº‹ä»¶
            document.querySelector('.tips-close-btn').onclick = () => document.getElementById('tips-modal').classList.add('hidden');
            document.querySelector('.check-in-close-btn').onclick = () => closeCheckInModal();
            document.getElementById('start-camera-btn').onclick = startCamera;
            document.getElementById('take-photo-btn').onclick = takePhoto;
            document.getElementById('photo-upload-input').onchange = handleFileUpload;
            document.getElementById('submit-check-in-btn').onclick = submitCheckIn;
            document.getElementById('skip-photo-btn').onclick = () => submitCheckIn(true);

            loadAppData(); // å°è¯•åŠ è½½æ‰€æœ‰æœ¬åœ°æ•°æ®
            loadUser();    // æ£€æŸ¥ç”¨æˆ·èº«ä»½å¹¶è¿›å…¥åº”ç”¨
        });

        /** åŠ è½½æ‰€æœ‰æœ¬åœ°æ•°æ® */
        function loadAppData() {
            const dataKeys = ['tasks', 'rewards', 'points', 'taskRecords', 'messages'];
            dataKeys.forEach(key => {
                const stored = localStorage.getItem(LS_PREFIX + key);
                if (stored) {
                    try {
                        if (key === 'points') {
                            appData[key] = parseInt(stored) || 0;
                        } else {
                            // é’ˆå¯¹ä»»åŠ¡å’Œè®°å½•çš„å…¼å®¹æ€§å¤„ç†ï¼Œé˜²æ­¢æ—§æ•°æ®å´©æºƒ
                            const parsed = JSON.parse(stored);
                            if (key === 'tasks') {
                                // ç¡®ä¿æ—§ä»»åŠ¡æœ‰ requiresPhoto å­—æ®µ
                                appData[key] = parsed.map(t => ({...t, requiresPhoto: t.requiresPhoto || false}));
                            } else if (key === 'taskRecords') {
                                // ç¡®ä¿æ—§è®°å½•æœ‰ status å­—æ®µ
                                appData[key] = parsed.map(r => ({...r, status: r.status || TASK_STATUS.COMPLETED}));
                            } else {
                                appData[key] = parsed;
                            }
                        }
                    } catch (e) {
                        console.error(`Error parsing ${key} data:`, e);
                        // æ¢å¤é»˜è®¤ç©ºæ•°ç»„/0
                        if (key === 'points') appData[key] = 0; else appData[key] = [];
                    }
                }
            });
        }

        /** ä¿å­˜æŒ‡å®šæ¨¡å—æ•°æ® */
        function saveAppData(key) {
            if (key === 'points') {
                localStorage.setItem(LS_PREFIX + key, appData[key]);
            } else {
                localStorage.setItem(LS_PREFIX + key, JSON.stringify(appData[key]));
            }
        }

        /** æ£€æŸ¥å¹¶åŠ è½½ç”¨æˆ·èº«ä»½ */
        function loadUser() {
            const storedIdentity = localStorage.getItem(LS_PREFIX + 'identity');
            const storedNickname = localStorage.getItem(LS_PREFIX + 'nickname');
            const storedRemember = localStorage.getItem(LS_PREFIX + 'remember') === 'true';
            const storedPassword = localStorage.getItem(LS_PREFIX + 'password');
            const storedSecretKey = localStorage.getItem(LS_PREFIX + 'secretKey');
            const storedPartnerKey = localStorage.getItem(LS_PREFIX + 'partnerKey');

            if (storedRemember && storedIdentity && storedNickname) {
                currentUser.identity = storedIdentity;
                currentUser.nickname = storedNickname;
                currentUser.remember = storedRemember;
                currentUser.password = storedPassword;
                currentUser.secretKey = storedSecretKey;
                currentUser.partnerKey = storedPartnerKey;
                
                if (currentUser.password) {
                    promptPasswordVerification(showMainApp, showAuthPage);
                } else {
                    showMainApp();
                }
            } else {
                showAuthPage();
            }
        }

        /** å¤„ç†å¯åŠ¨æŒ‰é’®ç‚¹å‡» */
        function handleStartApp() {
            const identity = document.querySelector('input[name="identity"]:checked').value;
            const nickname = document.getElementById('nickname-input').value.trim();
            const remember = document.getElementById('remember-me').checked;
            const password = document.getElementById('local-password').value.trim();
            const partnerKeyInput = document.getElementById('secret-key-input').value.trim().toUpperCase();

            if (!nickname) {
                alert('è¯·è¾“å…¥æ‚¨çš„ä¸“å±æ˜µç§°ï¼');
                return;
            }

            currentUser.identity = identity;
            currentUser.nickname = nickname;
            currentUser.remember = remember;
            
            // 1. å¤„ç†å¯†ç å’Œè‡ªå·±çš„å¯†é’¥ç”Ÿæˆ
            if (password) {
                currentUser.password = btoa(password);
                // å¦‚æœæ˜¯é¦–æ¬¡è®¾ç½®å¯†ç ï¼Œæˆ–è€…å¯†é’¥ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆæ–°çš„å¯†é’¥
                if (!currentUser.secretKey) {
                    currentUser.secretKey = generateSecretKey();
                }
            } else {
                currentUser.password = null;
                currentUser.secretKey = null; // æœªè®¾ç½®å¯†ç åˆ™æ— æ³•ç”Ÿæˆå¯†é’¥
            }
            
            // 2. å¤„ç†å¯¹æ–¹çš„å¯†é’¥
            currentUser.partnerKey = partnerKeyInput || null;


            if (remember) {
                saveUser();
            }
            
            showMainApp();
            
            // 3. é¦–æ¬¡è¿›å…¥æ˜¾ç¤ºè‡ªå·±çš„å¯†é’¥ï¼ˆå¦‚æœå·²ç”Ÿæˆï¼‰
            if (currentUser.secretKey && !localStorage.getItem(LS_PREFIX + 'identity')) {
                 showMySecretKey(true); // é¦–æ¬¡è¿›å…¥å¼ºåˆ¶å±•ç¤º
            }
        }

        /** æŒä¹…åŒ–ç”¨æˆ·èº«ä»½ä¿¡æ¯ */
        function saveUser() {
            localStorage.setItem(LS_PREFIX + 'identity', currentUser.identity);
            localStorage.setItem(LS_PREFIX + 'nickname', currentUser.nickname);
            localStorage.setItem(LS_PREFIX + 'remember', currentUser.remember);
            
            if (currentUser.password) {
                localStorage.setItem(LS_PREFIX + 'password', currentUser.password);
            } else {
                localStorage.removeItem(LS_PREFIX + 'password');
            }
            
            if (currentUser.secretKey) {
                localStorage.setItem(LS_PREFIX + 'secretKey', currentUser.secretKey);
            } else {
                localStorage.removeItem(LS_PREFIX + 'secretKey');
            }
            
            if (currentUser.partnerKey) {
                localStorage.setItem(LS_PREFIX + 'partnerKey', currentUser.partnerKey);
            } else {
                localStorage.removeItem(LS_PREFIX + 'partnerKey');
            }
        }

        /** æ˜¾ç¤ºå¯åŠ¨é¡µ */
        function showAuthPage() {
            document.getElementById('auth-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            
            document.getElementById('local-password').value = ''; 
            document.getElementById('nickname-input').value = currentUser.nickname || '';
            document.getElementById('secret-key-input').value = currentUser.partnerKey || '';
            document.getElementById('secret-key-display').classList.add('hidden'); // éšè—å¯†é’¥å±•ç¤ºåŒº
        }

        /** æ˜¾ç¤ºä¸»åº”ç”¨ç•Œé¢ */
        function showMainApp() {
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            document.getElementById('current-user-display').innerHTML = 
                `<i class="fas fa-user-circle"></i> **${currentUser.nickname}** (${currentUser.identity === 'parent' ? 'å®¶é•¿' : 'å­¦ç”Ÿ'})`;
            
            loadModule('tasks'); // é»˜è®¤åŠ è½½ä»»åŠ¡æ¨¡å—
            showRandomTip();
        }

        // --- II. è®¾ç½®ä¸æƒé™åŠŸèƒ½ ---
        
        function showMySecretKey(isInitial = false) {
             if (!isInitial) toggleSettingsMenu(); // å¦‚æœä¸æ˜¯é¦–æ¬¡è¿›å…¥ï¼Œå…³é—­è®¾ç½®èœå•
             const keyDisplay = document.getElementById('secret-key-display');
             
             if (!currentUser.secretKey) {
                 alert('æ‚¨å°šæœªè®¾ç½®æœ¬åœ°å¯†ç ï¼Œæ— æ³•ç”Ÿæˆå’ŒæŸ¥çœ‹é…å¯¹å¯†é’¥ã€‚è¯·è¿”å›å¯åŠ¨é¡µè®¾ç½®å¯†ç ã€‚');
                 keyDisplay.classList.add('hidden');
                 return;
             }
             
             document.getElementById('my-secret-key').textContent = currentUser.secretKey;
             keyDisplay.classList.remove('hidden');
             
             if (!isInitial) {
                 setTimeout(() => {
                     keyDisplay.classList.add('hidden');
                 }, 10000); // 10ç§’åè‡ªåŠ¨éšè—
             }
        }

        function toggleSettingsMenu() {
            document.getElementById('settings-menu').classList.toggle('hidden');
            document.getElementById('secret-key-display').classList.add('hidden'); // åˆ‡æ¢æ—¶éšè—å¯†é’¥
        }

        function promptChangeNickname() {
            toggleSettingsMenu();
            const newNickname = prompt(`è¯·è¾“å…¥æ–°çš„æ˜µç§° (å½“å‰: ${currentUser.nickname}):`);
            if (newNickname && newNickname.trim()) {
                currentUser.nickname = newNickname.trim();
                if (currentUser.remember) {
                    saveUser();
                }
                showMainApp(); // åˆ·æ–°æ˜¾ç¤º
                alert('æ˜µç§°ä¿®æ”¹æˆåŠŸï¼');
            } else if (newNickname !== null) {
                alert('æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼');
            }
        }

        function switchToAuthPage() {
            if (confirm('ç¡®å®šè¦åˆ‡æ¢èº«ä»½å—ï¼Ÿ')) {
                showAuthPage();
            }
        }

        function clearLocalData() {
            if (confirm('è­¦å‘Šï¼šç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„èº«ä»½ã€æ˜µç§°ã€å¯†é’¥ã€ä»»åŠ¡å’Œç•™è¨€æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
                // ä»…æ¸…é™¤æœ¬åº”ç”¨ç›¸å…³çš„æ•°æ®
                Object.keys(localStorage).filter(key => key.startsWith(LS_PREFIX)).forEach(key => {
                    localStorage.removeItem(key);
                });
                alert('æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…é™¤ã€‚è¯·é‡æ–°è®¾ç½®èº«ä»½å’Œæ˜µç§°ã€‚');
                window.location.reload(); 
            }
        }

        /** å¯†ç éªŒè¯é€»è¾‘ */
        function promptPasswordVerification(onSuccess, onFailure) {
            let attempts = 3;
            while (attempts > 0) {
                const inputPassword = prompt(`è¯·è¾“å…¥æœ¬åœ°å¯†ç  (${attempts}æ¬¡æœºä¼š):`);
                if (inputPassword === null) {
                    return onFailure(); // ç”¨æˆ·å–æ¶ˆ
                }
                
                if (btoa(inputPassword) === currentUser.password) {
                    return onSuccess();
                }
                
                attempts--;
                alert(`å¯†ç é”™è¯¯ï¼æ‚¨è¿˜æœ‰ ${attempts} æ¬¡æœºä¼šã€‚`);
            }

            alert('å¯†ç é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè¯·é‡æ–°é€‰æ‹©èº«ä»½æˆ–æ¸…é™¤æœ¬åœ°æ•°æ®ã€‚');
            onFailure();
        }

        // --- III. è·¯ç”±/æ¨¡å—åˆ‡æ¢ ---

        function loadModule(moduleName) {
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„ active çŠ¶æ€
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('settings-menu').classList.add('hidden'); // åˆ‡æ¢æ¨¡å—æ—¶éšè—è®¾ç½®èœå•

            const container = document.getElementById('content-container');
            
            if (moduleName === 'tasks') {
                document.getElementById('nav-tasks').classList.add('active');
                
                if (currentUser.identity === 'parent') {
                    // å®¶é•¿ç«¯æ˜¾ç¤ºå¾…å®¡æ ¸åˆ—è¡¨
                    container.innerHTML = `
                        <div id="tasks-module">
                            <h3>ğŸ† ä»»åŠ¡å®¡æ ¸ä¸æ‰“å¡å¥–åŠ±</h3>
                            <div class="card">
                                æ‚¨çš„å½“å‰ç§¯åˆ†ï¼š<span id="current-points">${appData.points}</span>
                            </div>
                            
                            <div id="parent-task-controls">
                                <button id="create-task-btn"><i class="fas fa-plus-circle"></i> åˆ›å»ºæ–°ä»»åŠ¡</button>
                                <button id="manage-rewards-btn"><i class="fas fa-gift"></i> ç®¡ç†å…‘æ¢å¥–åŠ±</button>
                            </div>
                            
                            <h4>å¾…å®¡æ ¸æ‰“å¡ (${appData.taskRecords.filter(r => r.status === TASK_STATUS.PENDING).length}) <i class="fas fa-hourglass-half"></i></h4>
                            <div id="pending-review-list"></div>

                            <h4>ä»»åŠ¡åˆ—è¡¨ <i class="fas fa-clipboard-list"></i></h4>
                            <div id="task-filter">
                                <button id="filter-all" class="active">å…¨éƒ¨</button>
                                <button id="filter-study">å­¦ç§‘</button>
                                <button id="filter-chore">å®¶åŠ¡</button>
                            </div>
                            <div id="task-list"></div>

                            <h4>å…‘æ¢å¥–åŠ±åˆ—è¡¨ <i class="fas fa-gift"></i></h4>
                            <div id="rewards-list"></div>
                        </div>
                    `;
                } else {
                    // å­¦ç”Ÿç«¯æ˜¾ç¤ºæ‰“å¡ã€å…‘æ¢å’Œæˆå°±
                    container.innerHTML = `
                        <div id="tasks-module">
                            <h3>ğŸ† æˆ‘çš„æ‰“å¡ä¸æˆå°±</h3>
                            <div class="card">
                                æ‚¨çš„å½“å‰ç§¯åˆ†ï¼š<span id="current-points">${appData.points}</span>
                                <button id="exchange-points-btn">å…‘æ¢å¥–åŠ±</button>
                            </div>
                            
                            <h4>ä»»åŠ¡åˆ—è¡¨ <i class="fas fa-clipboard-list"></i></h4>
                            <div id="task-filter">
                                <button id="filter-all" class="active">å…¨éƒ¨</button>
                                <button id="filter-study">å­¦ç§‘</button>
                                <button id="filter-chore">å®¶åŠ¡</button>
                            </div>
                            <div id="task-list"></div>

                            <h4>å…‘æ¢å¥–åŠ±åˆ—è¡¨ <i class="fas fa-gift"></i></h4>
                            <div id="rewards-list"></div>

                            <h4>æ‰“å¡è®°å½•ä¸æˆå°± <i class="fas fa-calendar-check"></i></h4>
                            <div id="achievement-badges"></div>
                            <div id="task-records-display"></div>
                        </div>
                    `;
                }

                initTaskModule();
            } else if (moduleName === 'messages') {
                document.getElementById('nav-messages').classList.add('active');
                container.innerHTML = `
                    <div id="messages-module">
                        <h3>ğŸ’¬ äº²å­åŒå‘ç•™è¨€å¢™</h3>
                        <div id="parent-reminder-area" class="message-area"><h4>å®¶é•¿æé†’åŒº</h4><div id="reminder-list"></div></div>
                        <div id="student-feedback-area" class="message-area"><h4>å­©å­åé¦ˆåŒº</h4><div id="feedback-list"></div></div>
                        <div id="private-wall-area" class="message-area">
                            <h4>ğŸ”’ äº²å­ç§å¯†ç•™è¨€å¢™</h4>
                            <div id="partner-key-prompt" class="${currentUser.partnerKey ? 'hidden' : ''} card danger" style="border-left-color: var(--danger-color);">
                                âš ï¸ æ‚¨çš„ç§å¯†ç•™è¨€åŠŸèƒ½æœªæ¿€æ´»ï¼è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­è¾“å…¥å¯¹æ–¹çš„**é…å¯¹å¯†é’¥**ã€‚
                            </div>
                            <button id="view-private-btn" ${currentUser.partnerKey ? '' : 'disabled'}>
                                ${currentUser.partnerKey ? 'æŸ¥çœ‹/å‘å¸ƒç§å¯†ç•™è¨€' : 'è¯·å…ˆè®¾ç½®å¯¹æ–¹å¯†é’¥'}
                            </button>
                            <div id="private-list"></div>
                        </div>
                        
                        <div class="card">
                            <h4>ğŸ“ å‘å¸ƒç•™è¨€</h4>
                            <div id="post-message-area">
                                <textarea id="message-input" placeholder="è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹..."></textarea>
                                <select id="message-type">
                                    <option value="reminder" ${currentUser.identity === 'student' ? 'disabled' : ''} ${currentUser.identity === 'parent' ? 'selected' : ''}>å®¶é•¿æé†’ (å…¬å¼€)</option>
                                    <option value="feedback" ${currentUser.identity === 'parent' ? 'disabled' : ''} ${currentUser.identity === 'student' ? 'selected' : ''}>å­©å­åé¦ˆ (å…¬å¼€)</option>
                                    <option value="private" ${currentUser.partnerKey ? '' : 'disabled'}>äº²å­ç§å¯† (éœ€å¯†é’¥)</option>
                                </select>
                                <select id="message-emoji">
                                    <option value="">é€‰æ‹©è¡¨æƒ…</option>
                                    <option value="ğŸ˜Š">ğŸ˜Š å¿«ä¹</option>
                                    <option value="ğŸ’ª">ğŸ’ª åŠªåŠ›</option>
                                    <option value="ğŸ’¡">ğŸ’¡ æƒ³æ³•</option>
                                    <option value="ğŸ˜°">ğŸ˜° å‹åŠ›</option>
                                    <option value="â“">â“ ç–‘é—®</option>
                                </select>
                                <button id="post-message-btn">å‘å¸ƒ</button>
                            </div>
                        </div>
                    </div>
                `;
                initMessageModule();
            } else if (moduleName === 'leaderboard') {
                document.getElementById('nav-leaderboard').classList.add('active');
                container.innerHTML = `
                    <div id="leaderboard-module">
                        <h3>ğŸ… æœˆåº¦æ‰“å¡ç§¯åˆ†æ’è¡Œæ¦œ</h3>
                        <p>æ’è¡Œæ¦œåŸºäºæ‰€æœ‰ç”¨æˆ·çš„æœ¬åœ°æ‰“å¡è®°å½•è®¡ç®—å¾—å‡ºã€‚</p>
                        <div id="leaderboard-display"></div>
                    </div>
                `;
                displayLeaderboard();
            }
        }

        /** éšæœºå­¦ä¹ Tipså¼¹çª— */
        function showRandomTip() {
            const tipsModal = document.getElementById('tips-modal');
            const tipContent = document.getElementById('tip-content');
            
            // æ¯éš”ä¸€æ®µæ—¶é—´å¼¹å‡º (ä¾‹å¦‚ 15ç§’å)
            setTimeout(() => {
                // ç¡®ä¿ modal ä»å¯è§ï¼ˆç”¨æˆ·å¯èƒ½å·²ç»æ“ä½œç¦»å¼€ï¼‰
                if (document.getElementById('main-app').classList.contains('hidden')) return;

                const randomTip = TIPS[Math.floor(Math.random() * TIPS.length)];
                tipContent.textContent = randomTip;
                tipsModal.classList.remove('hidden');
            }, 15000);
        }


        // --- IV. æ‰“å¡å¥–åŠ±æ¨¡å— (Task Logic) ---

        let currentFilter = 'all';

        function initTaskModule() {
            displayTasks();
            displayRewards();
            displayBadges();
            displayTaskRecords();

            // ç»‘å®šæŒ‰é’®
            if (currentUser.identity === 'parent') {
                displayPendingReviews(); // å®¶é•¿ç«¯ç‰¹æœ‰
                document.getElementById('create-task-btn').addEventListener('click', () => openTaskModal());
                document.getElementById('manage-rewards-btn').addEventListener('click', () => openRewardModal());
            } else {
                // å­¦ç”Ÿç‚¹å‡»å…‘æ¢å¥–åŠ±æŒ‰é’®æ—¶ï¼Œåªæ˜¯åˆ·æ–°å¥–åŠ±åˆ—è¡¨
                document.getElementById('exchange-points-btn').addEventListener('click', displayRewards);
            }
            document.getElementById('save-task-btn').addEventListener('click', saveTask);
            document.getElementById('save-reward-btn').addEventListener('click', saveReward);
            
            // å…³é—­Modalçš„äº‹ä»¶ç»‘å®š
            document.querySelectorAll('.task-close-btn').forEach(btn => 
                btn.onclick = () => document.getElementById('task-modal').classList.add('hidden')
            );
            document.querySelectorAll('.reward-close-btn').forEach(btn => 
                btn.onclick = () => document.getElementById('reward-modal').classList.add('hidden')
            );
            
            // ç­›é€‰äº‹ä»¶
            document.querySelectorAll('#task-filter button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#task-filter button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.id.split('-')[1];
                    displayTasks();
                });
            });
        }

        /** ä»»åŠ¡ç®¡ç† (å®¶é•¿) */
        function openTaskModal(task = {}) {
            document.getElementById('task-id').value = task.id || '';
            document.getElementById('task-name').value = task.name || '';
            document.getElementById('task-category').value = task.category || 'study';
            document.getElementById('task-points').value = task.points || 10;
            document.getElementById('task-requires-photo').checked = task.requiresPhoto || false;
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const name = document.getElementById('task-name').value.trim();
            const category = document.getElementById('task-category').value;
            const points = parseInt(document.getElementById('task-points').value);
            const requiresPhoto = document.getElementById('task-requires-photo').checked;

            if (!name || !points || points <= 0 || isNaN(points)) {
                alert('è¯·ç¡®ä¿ä»»åŠ¡åç§°å’Œç§¯åˆ†æœ‰æ•ˆï¼');
                return;
            }

            if (id) {
                // ç¼–è¾‘ç°æœ‰ä»»åŠ¡
                const index = appData.tasks.findIndex(t => t.id == id);
                if (index !== -1) {
                    appData.tasks[index] = { id: parseInt(id), name, category, points, requiresPhoto };
                }
            } else {
                // åˆ›å»ºæ–°ä»»åŠ¡
                const newId = Date.now();
                appData.tasks.push({ id: newId, name, category, points, requiresPhoto });
            }
            
            saveAppData('tasks');
            document.getElementById('task-modal').classList.add('hidden');
            displayTasks();
        }

        /** å¥–åŠ±ç®¡ç† (å®¶é•¿) */
        function openRewardModal(reward = {}) {
            document.getElementById('reward-id').value = reward.id || '';
            document.getElementById('reward-name').value = reward.name || '';
            document.getElementById('reward-cost').value = reward.cost || 30;
            document.getElementById('reward-modal').classList.remove('hidden');
        }

        function saveReward() {
            const id = document.getElementById('reward-id').value;
            const name = document.getElementById('reward-name').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value);

            if (!name || !cost || cost <= 0 || isNaN(cost)) {
                alert('è¯·ç¡®ä¿å¥–åŠ±åç§°å’Œæ‰€éœ€ç§¯åˆ†æœ‰æ•ˆï¼');
                return;
            }

            if (id) {
                const index = appData.rewards.findIndex(r => r.id == id);
                if (index !== -1) {
                    appData.rewards[index] = { id: parseInt(id), name, cost };
                }
            } else {
                const newId = Date.now();
                appData.rewards.push({ id: newId, name, cost });
            }
            
            saveAppData('rewards');
            document.getElementById('reward-modal').classList.add('hidden');
            displayRewards();
        }

        /** æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨ (æ‰€æœ‰ç”¨æˆ·) */
        function displayTasks() {
            const list = document.getElementById('task-list');
            if (!list) return;
            
            let filteredTasks = appData.tasks;
            if (currentFilter !== 'all') {
                filteredTasks = appData.tasks.filter(t => t.category === currentFilter);
            }
            
            // è·å–ä»Šæ—¥å·²æ‰“å¡ä¸”çŠ¶æ€ä¸º pending æˆ– approved çš„ä»»åŠ¡IDåˆ—è¡¨
            const today = new Date().toISOString().split('T')[0];
            const todayCompletedTasks = appData.taskRecords
                .filter(r => r.date === today && (r.status === TASK_STATUS.PENDING || r.status === TASK_STATUS.APPROVED || r.status === TASK_STATUS.COMPLETED))
                .map(r => r.taskId);
            
            
            list.innerHTML = filteredTasks.map(task => {
                const isCompleted = todayCompletedTasks.includes(task.id);
                const taskTodayStatus = appData.taskRecords.find(r => r.date === today && r.taskId === task.id)?.status;
                
                let buttonHtml;
                if (currentUser.identity === 'student') {
                    if (isCompleted) {
                         const statusText = taskTodayStatus === TASK_STATUS.PENDING ? 'å¾…å®¡æ ¸' : 'å·²æ‰“å¡';
                         const statusClass = taskTodayStatus === TASK_STATUS.PENDING ? 'warning pending' : 'approved';
                         buttonHtml = `<button class="${statusClass}" disabled>${statusText}</button>`;
                    } else {
                         buttonHtml = `<button onclick="openCheckInModal(${task.id})"><i class="fas fa-check"></i> æ‰“å¡</button>`;
                    }
                } else {
                    buttonHtml = `<div>
                        <button onclick="openTaskModal(${JSON.stringify(task).replace(/"/g, '&quot;')})"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                        <button class="danger" onclick="deleteItem('tasks', ${task.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
                    </div>`;
                }
                
                return `
                    <div class="task-item" data-id="${task.id}">
                        <div class="task-info">
                            <span>${task.name} (${task.category === 'study' ? 'å­¦ç§‘' : 'å®¶åŠ¡'})</span>
                            <span>å¥–åŠ±: **${task.points}** ç§¯åˆ† ${task.requiresPhoto ? ' (éœ€ç…§ç‰‡è¯æ˜)' : ''}</span>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join('');
        }

        /** æ˜¾ç¤ºå¥–åŠ±åˆ—è¡¨ (æ‰€æœ‰ç”¨æˆ·) */
        function displayRewards() {
            const list = document.getElementById('rewards-list');
            if (!list) return;
            
            document.getElementById('current-points').textContent = appData.points;

            list.innerHTML = appData.rewards.map(reward => `
                <div class="reward-item" data-id="${reward.id}">
                    <div class="task-info">
                        <span>**${reward.name}**</span>
                        <span>æ‰€éœ€ç§¯åˆ†: **${reward.cost}**</span>
                    </div>
                    ${currentUser.identity === 'student' ? 
                        `<button ${appData.points >= reward.cost ? '' : 'disabled'} onclick="exchangeReward(${reward.id}, ${reward.cost}, '${reward.name}')">å…‘æ¢</button>` :
                        `<div>
                            <button onclick="openRewardModal(${JSON.stringify(reward).replace(/"/g, '&quot;')})"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                            <button class="danger" onclick="deleteItem('rewards', ${reward.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
                        </div>`
                    }
                </div>
            `).join('');
        }

        /** ä»»åŠ¡æ‰“å¡ Modal (å­¦ç”Ÿ) */
        function openCheckInModal(taskId) {
            currentCheckInTask = appData.tasks.find(t => t.id === taskId);
            if (!currentCheckInTask) return;

            document.getElementById('check-in-task-name').textContent = currentCheckInTask.name;
            document.getElementById('check-in-task-id').value = taskId;
            
            const photoSection = document.getElementById('check-in-photo-section');
            const skipPhotoBtn = document.getElementById('skip-photo-btn');
            
            // é‡ç½®çŠ¶æ€
            capturedPhotoData = null;
            document.getElementById('check-in-photo-preview').innerHTML = '';
            document.getElementById('video-stream').classList.add('hidden');
            document.getElementById('captured-image').classList.add('hidden');
            document.getElementById('take-photo-btn').classList.add('hidden');
            stopCamera();

            if (currentCheckInTask.requiresPhoto) {
                photoSection.classList.remove('hidden');
                skipPhotoBtn.classList.add('hidden');
                document.getElementById('submit-check-in-btn').textContent = 'âœ… æäº¤æ‰“å¡ç­‰å¾…å®¡æ ¸';
            } else {
                photoSection.classList.add('hidden');
                skipPhotoBtn.classList.remove('hidden');
                document.getElementById('submit-check-in-btn').textContent = 'âœ… ç«‹å³å®Œæˆæ‰“å¡';
            }

            document.getElementById('check-in-modal').classList.remove('hidden');
        }
        
        function closeCheckInModal() {
            stopCamera();
            document.getElementById('check-in-modal').classList.add('hidden');
        }

        /** æ‹ç…§åŠŸèƒ½ */
        async function startCamera() {
            const video = document.getElementById('video-stream');
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = currentStream;
                video.classList.remove('hidden');
                document.getElementById('start-camera-btn').classList.add('hidden');
                document.getElementById('take-photo-btn').classList.remove('hidden');
                document.getElementById('photo-upload-input').classList.add('hidden');
            } catch (err) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–ä½¿ç”¨æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚');
                console.error("Error accessing camera: ", err);
            }
        }
        
        function takePhoto() {
            const video = document.getElementById('video-stream');
            const canvas = document.getElementById('captured-image');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8); // JPEG æ ¼å¼ï¼Œ80% è´¨é‡
            
            document.getElementById('check-in-photo-preview').innerHTML = `<img src="${capturedPhotoData}" alt="Captured Photo">`;
            
            stopCamera();
            document.getElementById('video-stream').classList.add('hidden');
            document.getElementById('take-photo-btn').classList.add('hidden');
            document.getElementById('photo-upload-input').classList.remove('hidden');
            document.getElementById('start-camera-btn').classList.remove('hidden');
            alert('ç…§ç‰‡å·²æ•è·ï¼');
        }
        
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                capturedPhotoData = e.target.result;
                document.getElementById('check-in-photo-preview').innerHTML = `<img src="${capturedPhotoData}" alt="Uploaded Photo">`;
                alert('å›¾ç‰‡å·²ä¸Šä¼ ï¼');
            };
            reader.readAsDataURL(file);
        }

        /** æäº¤æ‰“å¡ */
        function submitCheckIn(skipPhoto = false) {
            if (currentCheckInTask.requiresPhoto && !capturedPhotoData && !skipPhoto) {
                 alert('æ­¤ä»»åŠ¡è¦æ±‚æ‹ç…§è¯æ˜ï¼Œè¯·å…ˆæ‹ç…§æˆ–ä¸Šä¼ å›¾ç‰‡ï¼');
                 return;
            }
            
            const task = currentCheckInTask;
            const status = (task.requiresPhoto && !skipPhoto) ? TASK_STATUS.PENDING : TASK_STATUS.COMPLETED;
            
            const record = {
                id: Date.now(),
                taskId: task.id,
                date: new Date().toISOString().split('T')[0],
                nickname: currentUser.nickname,
                taskName: task.name,
                points: task.points,
                requiresPhoto: task.requiresPhoto,
                photoData: capturedPhotoData,
                status: status
            };
            appData.taskRecords.push(record);
            
            if (status === TASK_STATUS.COMPLETED) {
                appData.points += task.points;
                saveAppData('points');
                alert(`ä»»åŠ¡ "${task.name}" ç«‹å³å®Œæˆï¼Œè·å¾— ${task.points} ç§¯åˆ†ï¼`);
            } else {
                alert(`ä»»åŠ¡ "${task.name}" æäº¤æˆåŠŸï¼Œç­‰å¾…å®¶é•¿å®¡æ ¸ï¼`);
            }
            
            saveAppData('taskRecords');
            closeCheckInModal();
            displayTasks();
            displayBadges();
            displayTaskRecords();
        }

        /** å­¦ç”Ÿå…‘æ¢å¥–åŠ± (ä¿æŒä¸å˜) */
        function exchangeReward(id, cost, name) {
            if (appData.points < cost) {
                alert('ç§¯åˆ†ä¸è¶³ï¼Œè¯·å…ˆå®Œæˆæ›´å¤šä»»åŠ¡ï¼');
                return;
            }
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} ç§¯åˆ†å…‘æ¢å¥–åŠ± "${name}" å—ï¼Ÿå…‘æ¢åç§¯åˆ†å°†æ‰£é™¤ï¼Œè¯·ä¸å®¶é•¿ç¡®è®¤å¥–åŠ±é¢†å–äº‹å®œã€‚`)) {
                appData.points -= cost;
                
                saveAppData('points');
                
                document.getElementById('current-points').textContent = appData.points;
                alert(`å…‘æ¢æˆåŠŸï¼æ‚¨çš„ ${name} å¥–åŠ±ä¿¡æ¯å·²è®°å½•ã€‚`);

                displayRewards();
            }
        }
        
        /** å®¶é•¿ï¼šæ˜¾ç¤ºå¾…å®¡æ ¸åˆ—è¡¨ */
        function displayPendingReviews() {
            const list = document.getElementById('pending-review-list');
            if (!list) return;
            
            const pendingRecords = appData.taskRecords.filter(r => r.status === TASK_STATUS.PENDING);
            
            if (pendingRecords.length === 0) {
                list.innerHTML = '<p>ğŸ‰ æš‚æ— å¾…å®¡æ ¸çš„æ‰“å¡è®°å½•ã€‚</p>';
                return;
            }
            
            list.innerHTML = pendingRecords.map(record => `
                <div class="card pending-review-item" data-id="${record.id}">
                    <div>
                        **${record.nickname}** æäº¤äº†ä»»åŠ¡ï¼š**${record.taskName}** (å¥–åŠ±: ${record.points}åˆ†)
                        <p style="font-size:0.8em; color: #777;">æäº¤æ—¶é—´: ${record.date}</p>
                        ${record.photoData ? 
                            `<div class="review-image-container">
                                <img src="${record.photoData}" alt="æ‰“å¡è¯æ˜ç…§ç‰‡">
                            </div>` : ''}
                    </div>
                    <div>
                        <button onclick="reviewTask(${record.id}, '${TASK_STATUS.APPROVED}')"><i class="fas fa-check"></i> é€šè¿‡</button>
                        <button class="danger" onclick="reviewTask(${record.id}, '${TASK_STATUS.REJECTED}')"><i class="fas fa-times"></i> é©³å›</button>
                    </div>
                </div>
            `).join('');
        }

        /** å®¶é•¿ï¼šå®¡æ ¸ä»»åŠ¡ */
        function reviewTask(recordId, newStatus) {
            const index = appData.taskRecords.findIndex(r => r.id === recordId);
            if (index === -1) return;
            
            const record = appData.taskRecords[index];
            record.status = newStatus;
            
            if (newStatus === TASK_STATUS.APPROVED) {
                appData.points += record.points;
                saveAppData('points');
                alert(`ä»»åŠ¡ "${record.taskName}" å®¡æ ¸é€šè¿‡ï¼Œå·²å‘æ”¾ ${record.points} ç§¯åˆ†ï¼`);
            } else if (newStatus === TASK_STATUS.REJECTED) {
                 alert(`ä»»åŠ¡ "${record.taskName}" å·²é©³å›ï¼Œå­¦ç”Ÿéœ€è¦é‡æ–°æ‰“å¡ã€‚`);
            }
            
            saveAppData('taskRecords');
            displayPendingReviews(); // åˆ·æ–°å¾…å®¡æ ¸åˆ—è¡¨
            displayTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼Œè®©å­¦ç”Ÿå¯ä»¥é‡æ–°æ‰“å¡
        }


        // ... (V. åŒå‘ç•™è¨€æ¨¡å— å’Œ VI. æ’è¡Œæ¦œæ¨¡å— ä¿æŒä¸å˜)

        // --- V. åŒå‘ç•™è¨€æ¨¡å— (Message Logic) ---

        let privateUnlocked = false;

        function initMessageModule() {
            // ç»‘å®šå‘å¸ƒäº‹ä»¶
            document.getElementById('post-message-btn').addEventListener('click', postMessage);
            document.getElementById('view-private-btn').addEventListener('click', togglePrivateMessages);
            
            // åˆå§‹åŒ–æ˜¾ç¤º
            displayMessages();
        }

        /** å‘å¸ƒç•™è¨€ */
        function postMessage() {
            const input = document.getElementById('message-input');
            const type = document.getElementById('message-type').value;
            const emoji = document.getElementById('message-emoji').value;
            const content = input.value.trim();

            if (!content) {
                alert('ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            if (type === 'reminder' && currentUser.identity === 'student') {
                alert('æ‚¨æ²¡æœ‰æƒé™å‘å¸ƒå®¶é•¿æé†’ï¼');
                return;
            }
            if (type === 'feedback' && currentUser.identity === 'parent') {
                alert('æ‚¨æ²¡æœ‰æƒé™å‘å¸ƒå­©å­åé¦ˆï¼');
                return;
            }
            if (type === 'private' && !currentUser.partnerKey) {
                 alert('è¯·å…ˆåœ¨å¯åŠ¨é¡µæˆ–è®¾ç½®ä¸­è¾“å…¥å¯¹æ–¹çš„é…å¯¹å¯†é’¥æ‰èƒ½å‘é€ç§å¯†æ¶ˆæ¯ï¼');
                 return;
            }

            let messageContent = content;
            if (type === 'private') {
                // ç§å¯†æ¶ˆæ¯éœ€è¦åŠ å¯†ï¼Œä½¿ç”¨å¯¹æ–¹çš„å¯†é’¥
                messageContent = encryptMessage(content, currentUser.partnerKey);
            }

            const newMessage = {
                id: Date.now(),
                sender: currentUser.nickname,
                identity: currentUser.identity,
                type: type, // reminder, feedback, private
                content: messageContent, // å¯èƒ½æ˜¯åŠ å¯†å†…å®¹
                timestamp: new Date().toLocaleString(),
                emoji: emoji
            };

            appData.messages.push(newMessage);
            saveAppData('messages');
            input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('message-emoji').value = ''; // æ¸…ç©ºè¡¨æƒ…é€‰æ‹©
            
            // å¦‚æœæ˜¯ç§å¯†æ¶ˆæ¯ï¼Œå¼ºåˆ¶è§£é”åˆ·æ–°
            if (type === 'private' && privateUnlocked) {
                 displayMessages();
            } else if (type !== 'private') {
                 displayMessages();
            }
        }

        /** åˆ é™¤ç•™è¨€ */
        function deleteMessage(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                // åªèƒ½åˆ é™¤è‡ªå·±å‘å¸ƒçš„ç•™è¨€
                appData.messages = appData.messages.filter(msg => msg.id !== id || msg.sender !== currentUser.nickname);
                saveAppData('messages');
                displayMessages();
            }
        }

        /** åˆ‡æ¢ç§å¯†ç•™è¨€çš„å¯è§æ€§ */
        function togglePrivateMessages() {
            if (!currentUser.partnerKey) {
                alert('è¯·å…ˆåœ¨å¯åŠ¨é¡µæˆ–è®¾ç½®ä¸­è¾“å…¥å¯¹æ–¹çš„é…å¯¹å¯†é’¥ï¼');
                return;
            }
            
            if (privateUnlocked) {
                // å¦‚æœå·²è§£é”ï¼Œåˆ™é”å®š
                privateUnlocked = false;
                document.getElementById('view-private-btn').textContent = 'æŸ¥çœ‹/å‘å¸ƒç§å¯†ç•™è¨€';
                displayMessages();
                return;
            }
            
            // æç¤ºç”¨æˆ·éªŒè¯èº«ä»½ (è¾“å…¥æœ¬åœ°å¯†ç )
            if (currentUser.password) {
                promptPasswordVerification(() => {
                    privateUnlocked = true;
                    document.getElementById('view-private-btn').textContent = 'ğŸ”’ ç§å¯†ç•™è¨€å¢™ (å·²è§£é”)';
                    displayMessages();
                    alert('ç§å¯†ç•™è¨€å¢™å·²è§£é”ï¼');
                }, () => {
                    alert('å¯†ç éªŒè¯å¤±è´¥ï¼Œæ— æ³•æŸ¥çœ‹ç§å¯†ç•™è¨€ã€‚');
                });
            } else {
                // æœªè®¾ç½®å¯†ç ï¼Œç›´æ¥è§£é”
                privateUnlocked = true;
                document.getElementById('view-private-btn').textContent = 'ğŸ”’ ç§å¯†ç•™è¨€å¢™ (å·²è§£é”)';
                displayMessages();
                alert('ç§å¯†ç•™è¨€å¢™å·²è§£é” (æœªè®¾ç½®æœ¬åœ°å¯†ç ï¼Œè¯·æ³¨æ„å®‰å…¨)ã€‚');
            }
        }

        /** æ˜¾ç¤ºæ‰€æœ‰ç•™è¨€ */
        function displayMessages() {
            const reminderList = document.getElementById('reminder-list');
            const feedbackList = document.getElementById('feedback-list');
            const privateList = document.getElementById('private-list');

            if (!reminderList) return; 

            const reminders = appData.messages.filter(m => m.type === 'reminder');
            const feedbacks = appData.messages.filter(m => m.type === 'feedback');
            const privates = appData.messages.filter(m => m.type === 'private');

            // æ¸²æŸ“æ™®é€šç•™è¨€
            reminderList.innerHTML = renderMessageList(reminders);
            feedbackList.innerHTML = renderMessageList(feedbacks);

            // æ¸²æŸ“ç§å¯†ç•™è¨€
            if (privateUnlocked) {
                privateList.innerHTML = renderMessageList(privates, true);
            } else {
                privateList.innerHTML = privates.length > 0 ? 
                    '<div class="locked-message">ğŸ”‘ æœ‰æ–°çš„ç§å¯†ç•™è¨€ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®éªŒè¯èº«ä»½åæŸ¥çœ‹ã€‚</div>' :
                    '<p>æš‚æ— ç§å¯†ç•™è¨€ã€‚</p>';
            }
        }

        /** æ¸²æŸ“å•æ¡ç•™è¨€åˆ—è¡¨ */
        function renderMessageList(messages, isPrivate = false) {
            if (messages.length === 0) return `<p>æš‚æ— ${isPrivate ? 'ç§å¯†' : ''}ç•™è¨€ã€‚</p>`;
            
            // ç•™è¨€æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedMessages = messages.sort((a, b) => b.id - a.id);
            
            return sortedMessages.map(msg => {
                let content = msg.content;
                
                if (isPrivate) {
                    // å°è¯•ä½¿ç”¨è‡ªå·±çš„å¯†é’¥è§£å¯†
                    const decrypted = decryptMessage(msg.content, currentUser.secretKey);
                    
                    if (decrypted) {
                        content = decrypted;
                    } else if (msg.sender === currentUser.nickname) {
                        // å¦‚æœæ˜¯è‡ªå·±å‘é€çš„ï¼Œä½†è§£å¯†å¤±è´¥ï¼ˆå¯èƒ½æ˜¯é…å¯¹å¯†é’¥æ›´æ–°ï¼‰ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹ï¼ˆåŠ å¯†å‰çš„å†…å®¹ï¼‰
                        content = "âš ï¸ (è§£å¯†å¤±è´¥) " + msg.content;
                    } else {
                        // å¯¹æ–¹å‘é€çš„ï¼Œè§£å¯†å¤±è´¥ï¼Œæ˜¾ç¤ºæ— æ³•æŸ¥çœ‹
                        content = 'âŒ æ¶ˆæ¯å·²è¢«åŠ å¯†ï¼Œæ— æ³•æŸ¥çœ‹ã€‚';
                    }
                }
                
                return `
                    <div class="message-item ${msg.type}">
                        <div class="message-meta">
                            <span>${msg.emoji} **${msg.sender}** (${msg.identity === 'parent' ? 'å®¶é•¿' : 'å­¦ç”Ÿ'})</span>
                            <span>${msg.timestamp}</span>
                        </div>
                        <div class="message-content">${content}</div>
                        ${msg.sender === currentUser.nickname ? 
                            `<button class="message-delete-btn" onclick="deleteMessage(${msg.id})">
                                <i class="fas fa-times-circle"></i>
                            </button>` : ''}
                    </div>
                `;
            }).join('');
        }


        // --- VI. ç§¯åˆ†æ’è¡Œæ¦œæ¨¡å— (Leaderboard Logic) ---

        /** æ˜¾ç¤ºæ’è¡Œæ¦œ */
        function displayLeaderboard() {
            const container = document.getElementById('leaderboard-display');
            if (!container) return;
            
            // 1. èšåˆæ•°æ®: è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„æ€»ç§¯åˆ† (åªè®¡ç®—å·²æ‰¹å‡†/ç«‹å³å®Œæˆçš„è®°å½•)
            const monthlyPoints = {}; // { nickname: totalPoints }
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            appData.taskRecords.forEach(record => {
                if (record.date.startsWith(currentMonth) && (record.status === TASK_STATUS.APPROVED || record.status === TASK_STATUS.COMPLETED)) {
                    const nickname = record.nickname;
                    monthlyPoints[nickname] = (monthlyPoints[nickname] || 0) + record.points;
                }
            });
            
            // 2. è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const leaderboard = Object.entries(monthlyPoints)
                .map(([nickname, points]) => ({ nickname, points }))
                .sort((a, b) => b.points - a.points); // ç§¯åˆ†é«˜çš„åœ¨å‰
                
            if (leaderboard.length === 0) {
                container.innerHTML = '<p>æœ¬æœˆæš‚æ— å·²å®¡æ ¸é€šè¿‡çš„æ‰“å¡è®°å½•ï¼Œæ²¡æœ‰æ’è¡Œæ¦œæ•°æ®ã€‚</p>';
                return;
            }
            
            // 3. æ¸²æŸ“HTML
            let html = `
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f1f1f1;">
                            <th style="padding: 10px; border: 1px solid #ddd;">æ’å</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">æ˜µç§°</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">æœˆåº¦ç§¯åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            leaderboard.forEach((item, index) => {
                const rank = index + 1;
                const icon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `No.${rank}`;
                
                html += `
                    <tr style="background-color: ${item.nickname === currentUser.nickname ? '#e0f7fa' : 'white'};">
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${icon}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">**${item.nickname}** ${item.nickname === currentUser.nickname ? '(æˆ‘)' : ''}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: #e67e22;">**${item.points}**</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ----------------------- å¾½ç« å’Œè®°å½•æ˜¾ç¤º (Student View) -----------------------

        /** æˆå°±å¾½ç«  */
        function displayBadges() {
             // ç­›é€‰å‡ºå·²æ‰¹å‡†æˆ–ç«‹å³å®Œæˆçš„è®°å½•
            const records = appData.taskRecords.filter(r => r.nickname === currentUser.nickname && (r.status === TASK_STATUS.APPROVED || r.status === TASK_STATUS.COMPLETED));
            const badgeContainer = document.getElementById('achievement-badges');
            if (!badgeContainer) return;
            
            let badges = [];
            
            // è¿ç»­æ‰“å¡å¤©æ•°é€»è¾‘ (éœ€è¦ä¼˜åŒ–ä»¥é€‚åº”æ–°çŠ¶æ€ï¼Œä½†æ ¸å¿ƒé€»è¾‘ä¸å˜ï¼Œåªç»Ÿè®¡å·²é€šè¿‡çš„)
            // ... (è¿ç»­æ‰“å¡é€»è¾‘ä¿æŒä¸å˜ï¼Œç¡®ä¿åªç»Ÿè®¡ records)
            
            const today = new Date().toISOString().split('T')[0];
            const uniqueDates = [...new Set(records.map(r => r.date))].sort();
            let consecutiveDays = 0;
            
            if (uniqueDates.length > 0) {
                let currentStreak = 0;
                let lastDateStr = uniqueDates[uniqueDates.length - 1];
                let streakDate = new Date(lastDateStr);

                // æ£€æŸ¥ä»Šå¤©å’Œæ˜¨å¤©
                if (lastDateStr === today) {
                    currentStreak = 1;
                    streakDate.setDate(streakDate.getDate() - 1);
                } else if (new Date(lastDateStr).toISOString().split('T')[0] === new Date(new Date(today).setDate(new Date(today).getDate() - 1)).toISOString().split('T')[0]) {
                    currentStreak = 1;
                    // streakDate å·²ç»æ˜¯æ˜¨å¤©çš„æ—¥æœŸ
                } else {
                    streakDate.setDate(streakDate.getDate() - 1);
                }

                while (true) {
                    const checkDateStr = streakDate.toISOString().split('T')[0];
                    if (uniqueDates.includes(checkDateStr)) {
                        currentStreak++;
                        streakDate.setDate(streakDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                consecutiveDays = currentStreak;
            }

            if (consecutiveDays >= 7) {
                badges.push(`<span class="badge">ğŸ”¥ è¿ç»­æ‰“å¡ ${consecutiveDays} å¤©!</span>`);
            } else if (consecutiveDays > 0) {
                 badges.push(`<span class="badge">ğŸ—“ï¸ æŒç»­åŠªåŠ›ä¸­ (${consecutiveDays}å¤©)</span>`);
            }

            // å­¦ç§‘/å®¶åŠ¡è¾¾äºº
            const studyCount = records.filter(r => appData.tasks.find(t => t.name === r.taskName && t.category === 'study')).length;
            const choreCount = records.filter(r => appData.tasks.find(t => t.name === r.taskName && t.category === 'chore')).length;

            if (studyCount >= 10) badges.push('<span class="badge">ğŸ§  å­¦éœ¸å°èƒ½æ‰‹ (å®Œæˆ10ä¸ªå­¦ä¹ ä»»åŠ¡)!</span>');
            if (choreCount >= 5) badges.push('<span class="badge">ğŸ§¹ å®¶åŠ¡å°å¸®æ‰‹ (å®Œæˆ5ä¸ªå®¶åŠ¡ä»»åŠ¡)!</span>');

            badgeContainer.innerHTML = badges.join('');
        }

        /** æ˜¾ç¤ºæ‰“å¡è®°å½• */
        function displayTaskRecords() {
            const container = document.getElementById('task-records-display');
            if (!container) return;
            
            // ç­›é€‰å‡ºå½“å‰ç”¨æˆ·çš„è®°å½•ï¼Œå¹¶æŒ‰æ—¥æœŸå€’åº
            const records = appData.taskRecords.filter(r => r.nickname === currentUser.nickname)
                .sort((a, b) => b.id - a.id);
            
            if (records.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ‰“å¡è®°å½•ã€‚</p>';
                return;
            }
            
            const html = records.map(r => {
                let statusText;
                let borderColor;
                switch (r.status) {
                    case TASK_STATUS.PENDING: statusText = 'ï¼ˆå¾…å®¡æ ¸ï¼‰'; borderColor = var(--warning-color); break;
                    case TASK_STATUS.APPROVED: statusText = 'ï¼ˆå·²é€šè¿‡ï¼‰'; borderColor = var(--primary-color); break;
                    case TASK_STATUS.REJECTED: statusText = 'ï¼ˆå·²é©³å›ï¼‰'; borderColor = var(--danger-color); break;
                    case TASK_STATUS.COMPLETED: statusText = 'ï¼ˆå·²å®Œæˆï¼‰'; borderColor = '#5bc0de'; break;
                    default: statusText = ''; borderColor = '#5bc0de';
                }
                
                return `
                    <div class="card" style="border-left-color: ${borderColor};">
                        **${r.date}**ï¼šæäº¤ä»»åŠ¡ "**${r.taskName}**" ${statusText}ã€‚
                        <span style="float: right;">${r.status === TASK_STATUS.APPROVED || r.status === TASK_STATUS.COMPLETED ? `+**${r.points}**ç§¯åˆ†` : ''}</span>
                        ${r.photoData ? `<p style="font-size: 0.8em; color: #999;">ğŸ“¸ é™„å¸¦äº†ç…§ç‰‡è¯æ˜</p>` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

    </script>
</body>
</html>
